<div class="container py-4">
  <div class="row mb-4">
    <div class="col">
      <h1 class="display-4 fw-bold location-title">
        <i class="bi bi-globe2 me-3"></i>Locaciones del Multiverso
      </h1>
      <p class="lead text-muted">Explora las infinitas dimensiones de Rick y Morty</p>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-8 mb-3">
      <input
        type="text"
        class="form-control"
        placeholder="Buscar por nombre..."
        [value]="searchName()"
        (input)="onSearch($any($event.target).value)"
      />
    </div>
    <div class="col-md-4 mb-3">
      <select
        class="form-select"
        [value]="filterType()"
        (change)="onFilterType($any($event.target).value)"
      >
        @for (type of locationTypes; track type.value) {
          <option [value]="type.value">
            {{ type.label }}
          </option>
        }
      </select>
    </div>
  </div>

  @if (loading()) {
    <div class="text-center py-5">
      <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
    </div>
  } @else if (locations().length > 0) {
    <div class="row">
      @for (location of locations(); track location.id) {
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card h-100 location-card">
            <div class="card-body">
              <h5 class="card-title text-center mb-3">
                <i [class]="'bi ' + getTypeIcon(location.type) + ' me-2'"></i>
                {{ location.name }}
              </h5>
              <div class="d-flex flex-column gap-2">
                <p class="card-text mb-0 d-flex justify-content-between">
                  <strong>Tipo:</strong>
                  <span>{{ location.type }}</span>
                </p>
                <p class="card-text mb-0 d-flex justify-content-between">
                  <strong>Dimensión:</strong>
                  <span>{{ location.dimension || 'Desconocida' }}</span>
                </p>
                <p class="card-text mb-0 d-flex justify-content-between">
                  <strong>Residentes:</strong>
                  <span class="badge-residents">{{ location.residents.length }}</span>
                </p>
              </div>
            </div>
            <div class="card-footer bg-transparent">
              <button class="btn-detail-custom w-100" (click)="openLocationModal(location)">
                <span class="btn-content">
                  <i class="bi bi-info-circle-fill me-2"></i>
                  Detalles
                </span>
                <i class="bi bi-arrow-right-circle btn-arrow"></i>
              </button>
            </div>
          </div>
        </div>
      }
    </div>

    <nav aria-label="Paginación">
      <ul class="pagination justify-content-center">
        <li class="page-item" [class.disabled]="isCurrentPage(1) || isPaginationDisabled()">
          <button
            class="page-link"
            (click)="previousPage()"
            [disabled]="isCurrentPage(1) || isPaginationDisabled()"
          >
            Anterior
          </button>
        </li>

        @for (page of getPageNumbers(); track page) {
          @if (shouldShowEllipsis(page)) {
            <li class="page-item disabled">
              <span class="page-link">...</span>
            </li>
          } @else {
            <li class="page-item" [class.active]="isCurrentPage(page)">
              <button
                class="page-link"
                (click)="goToPage(page)"
                [disabled]="isPaginationDisabled()"
              >
                {{ page }}
              </button>
            </li>
          }
        }

        <li
          class="page-item"
          [class.disabled]="isCurrentPage(totalPages()) || isPaginationDisabled()"
        >
          <button
            class="page-link"
            (click)="nextPage()"
            [disabled]="isCurrentPage(totalPages()) || isPaginationDisabled()"
          >
            Siguiente
          </button>
        </li>
      </ul>
    </nav>
  } @else {
    <div class="alert alert-info text-center" role="alert">
      <h4 class="alert-heading">No se encontraron locaciones</h4>
      <p>Intenta ajustar los filtros de búsqueda</p>
    </div>
  }
</div>

@if (showModal()) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-container-location" (click)="$event.stopPropagation()">
      <div class="modal-content-location">
        @if (selectedLocation()) {
          <div class="modal-header-location">
            <h5 class="modal-title">
              <i [class]="'bi ' + getTypeIcon(selectedLocation()!.type) + ' me-2'"></i>
              {{ selectedLocation()!.name }}
            </h5>
            <button type="button" class="btn-close-custom" (click)="closeModal()">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>

          <div class="modal-body-location">
            <div class="location-details">
              <div class="detail-card">
                <div class="detail-icon">
                  <i class="bi bi-bookmark-fill"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Tipo de Locación</span>
                  <span class="detail-value">{{ selectedLocation()!.type }}</span>
                </div>
              </div>

              <div class="detail-card">
                <div class="detail-icon">
                  <i class="bi bi-stars"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Dimensión</span>
                  <span class="detail-value">{{
                    selectedLocation()!.dimension || 'Desconocida'
                  }}</span>
                </div>
              </div>

              <div class="detail-card">
                <div class="detail-icon">
                  <i class="bi bi-people-fill"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Total de Residentes</span>
                  <span class="detail-value">{{ selectedLocation()!.residents.length }}</span>
                </div>
              </div>
            </div>

            <hr class="divider" />

            <div class="residents-section">
              <h6 class="section-title">
                <i class="bi bi-person-badge me-2"></i>
                Residentes de esta Locación
              </h6>

              @if (loadingModal()) {
                <div class="text-center py-4">
                  <div class="spinner-border spinner-border-sm text-success" role="status">
                    <span class="visually-hidden">Cargando residentes...</span>
                  </div>
                </div>
              } @else if (hasResidents()) {
                <div class="characters-grid">
                  @for (character of locationCharacters(); track character.id) {
                    <div class="character-mini-card">
                      <img
                        [src]="character.image"
                        [alt]="character.name"
                        class="character-avatar"
                      />
                      <div class="character-info-mini">
                        <h6 class="character-name-mini">{{ character.name }}</h6>
                        <div class="character-details-mini">
                          <span
                            [class]="
                              'status-indicator ' + getCharacterStatusClass(character.status)
                            "
                          >
                            {{ getCharacterStatusLabel(character.status) }}
                          </span>
                          <span class="character-species">{{ character.species }}</span>
                        </div>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="no-residents">
                  <i class="bi bi-person-x-fill"></i>
                  <p>Esta locación no tiene residentes conocidos</p>
                </div>
              }
            </div>
          </div>

          <div class="modal-footer-location">
            <button type="button" class="btn-close-modal" (click)="closeModal()">
              <i class="bi bi-x-circle me-2"></i>Cerrar
            </button>
          </div>
        }
      </div>
    </div>
  </div>
}
